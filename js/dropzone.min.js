(function($){'use strict';$.fn.dropzone=function(j){var k=this;var l=$.extend({width:300,height:300,progressBarWidth:300,url:'',filesName:'files',margin:0,border:'2px dashed #ccc',background:'',textColor:'#ccc',textAlign:'center',lineHeight:300,text:'Drop files here to upload',uploadMode:'single',progressContainer:'',dropzoneWraper:'nniicc-dropzoneParent',files:[],maxFileSize:'10MB',allowedFileTypes:'*',clickToUpload:true,showTimer:true,removeComplete:true,load:null,progress:null,uploadDone:null,},j);var m={};var o={};var p={};var q=0;if(typeof $.ui=="undefined"){jQuery.getScript('https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js',function(){$('<link/>',{rel:'stylesheet',type:'text/css',href:'https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css'}).appendTo('head');init()})}else{init()}function init(){k.css({width:l.width,height:l.height,border:l.border,background:l.background,color:l.textColor,'text-align':l.textAlign,lineHeight:typeof l.lineHeight=="number"?l.lineHeight+"px":l.lineHeight});k.hover(function(){$(this).css("cursor","pointer")},function(){$(this).css("cursor","default")});k.html(l.text);k.wrap('<div class="'+l.dropzoneWraper+'"></div>');$("."+l.dropzoneWraper).css('margin',l.margin);if(l.progressContainer===''){l.progressContainer="."+l.dropzoneWraper}if(l.clickToUpload){$("."+l.dropzoneWraper).append('<form></form>');$("."+l.dropzoneWraper).find('form').append('<input type="file" multiple="multiple" name="'+l.filesName+'[]"/>').hide().bind('change',function(a){$(this).trigger('submit')}).on('submit',function(a){a.preventDefault();upload(a.target[0].files);var b=$(this).find('input');b.wrap('<form>').closest('form').get(0).reset();b.unwrap()})}k.bind({dragover:function(e){e.preventDefault();e.stopPropagation();k.css({color:'#000','border-color':'#000'})},dragleave:function(e){e.preventDefault();e.stopPropagation();dragLeave(k)},drop:function(e){e.preventDefault();dragLeave(k);if(l.url==='')alert('Upload targer not found!! please set it with \'url\' attribute');else upload(e.originalEvent.dataTransfer.files)},click:function(e){if(l.clickToUpload){if(l.url==='')alert('Upload targer not found!! please set it with \'url\' attribute');else $("."+l.dropzoneWraper).find('input').trigger('click')}}});if(typeof l.load=="function")l.load(k);function dragLeave(a){var b=l.textColor;var c=l.border.split(" ");if(c.length==3)b=c[2];k.css({color:l.textColor,'border-color':b})}function upload(c){if(c){l.files=c;if(l.removeComplete){var d=$(".progress-bar:not(.active)").parents('.extra-progress-wrapper');d.each(function(a,b){b.remove()})}var i,formData,xhr;if(l.uploadMode=='all'){p[0]=$.now();formData=new FormData();xhr=new XMLHttpRequest();for(i=0;i<c.length;i++){formData.append(l.filesName+'[]',c[i])}addProgressBar(0);bindXHR(xhr,0);xhr.open('post',l.url);xhr.setRequestHeader('Cache-Control','no-cache');xhr.send(formData);$(".progress").show()}else if(l.uploadMode=='single'){for(i=0;i<c.length;i++){p[q]=$.now();formData=new FormData();xhr=new XMLHttpRequest();if(!checkFileType(c[i])){addWrongFileField(i,q);q++;continue}if(!checkFileSize(c[i])){addFileToBigField(i,q);q++;continue}formData.append(l.filesName+'[]',c[i]);addProgressBar(i,q);bindXHR(xhr,i,q);xhr.open('post',l.url);xhr.setRequestHeader('Cache-Control','no-cache');xhr.send(formData);$(".progress").show();q++}}}showTooltip()}}function startTimer(i){o[i]=window.setInterval(function(){var a=$(".upload-timer-"+i);var b=$.now()-p[i];var c=b/1000;var d=0;if(c>=60){d=Math.round(c/60);c=c%60}a.text(d+":"+pad(c.toFixed(2),5))},10)}function pad(a,b){a=a.toString();return a.length<b?pad("0"+a,b):a}function bindXHR(d,i,f){$(d.upload).bind({progress:function(e){if(e.originalEvent.lengthComputable){var a=e.originalEvent.loaded/e.originalEvent.total*100;if(typeof l.progress=="function")l.progress(a,f);else{$(".progress-"+f).children().css("width",a+"%").html(a.toFixed(0)+"%")}}},loadstart:function(e,a,b,c){startTimer(f)}});m[f]=false;$(d).bind({readystatechange:function(){if(this.readyState==4&&this.status==200){changeXhrDoneStatus(f);$(".progress.progress-"+f).children().removeClass('active')}}});var g=setInterval(function(){if(Object.keys(m).length>0){var a={};for(var b in m){if(m[b]===true)a[b]=true}if(Object.keys(m).length==Object.keys(a).length){clearInterval(g);m={};if(typeof l.uploadDone=="function")l.uploadDone(k)}}},500)}function changeXhrDoneStatus(i){m[i]=true;clearInterval(o[i])}function addProgressBar(i,a){$(l.progressContainer).append('<div class="progress progress-'+a+'"></div>').css({'margin':l.margin});$(".progress-"+a).css({width:l.progressBarWidth,margin:'20px 0 0 0',}).append('<div class="progress-bar progress-bar-info progress-bar-striped active"></div>').hide();$(".progress-"+a).wrap('<div class="extra-progress-wrapper"></div>');$(".progress-"+a).parent().append('<span title="'+l.files[i].name+'">'+l.files[i].name.trunc(20)+'</span>').css("width",l.progressBarWidth);if(l.showTimer){$(".progress-"+a).parent().append('<span style="float:right" class="upload-timer-'+a+'">0</span>')}}function addFileToBigField(i,a){console.log(a);$(l.progressContainer).append('<div class="progress error-progress-'+a+'"></div>').css('margin',l.margin);var b=l.files[i];var c=b.name.trunc(25);$(".error-progress-"+a).css({width:l.progressBarWidth,margin:'20px 0 0 0'}).append('<div class="progress-bar progress-bar-danger progress-bar-striped" style="width:100%">File to big ('+formatBytes(b.size)+')</div>');$(".error-progress-"+a).wrap('<div class="extra-progress-wrapper"></div>').css("width",l.progressBarWidth);$(".error-progress-"+a).parent().append('<span title="'+l.files[i].name+'">'+c+'</span>')}function addWrongFileField(i,a){$(l.progressContainer).append('<div class="progress error-progress-'+a+'"></div>').css('margin',l.margin);var b=l.files[i];var c=b.name.trunc(25);var d=b.name.substr(b.name.lastIndexOf('.')+1);$(".error-progress-"+a).css({width:l.progressBarWidth,margin:'20px 0 0 0'}).append('<div class="progress-bar progress-bar-danger progress-bar-striped" style="width:100%">File type ('+d+') is not allowed</div>');$(".error-progress-"+a).wrap('<div class="extra-progress-wrapper"></div>').css("width",l.progressBarWidth);$(".error-progress-"+a).parent().append('<span title="'+l.files[i].name+'">'+c+'</span>')}function showTooltip(){$("span").tooltip({open:function(a,b){b.tooltip.css("max-width",'100%')}})}function checkFileType(a){if(!a.type&&a.size%4096===0)return false;if(l.allowedFileTypes=='*')return true;var b=a.name.substr(a.name.lastIndexOf('.')+1);var c=l.allowedFileTypes.replace(' ','').split(",");if($.inArray(b,c)!=-1)return true;return false}function checkFileSize(a){var b=['Bytes','KB','MB','GB','TB'];var c=l.maxFileSize.match(/[a-zA-Z]+/g)[0];var d=l.maxFileSize.match(/\d+/)[0];var e=$.inArray(c,b);if(e!=-1){var f=formatBytes(a.size);var g=f.match(/[a-zA-Z]+/g)[0];var h=f.match(/\d+/)[0];if(c==g){if(parseInt(h)<parseInt(d)){return true}}else{var i=$.inArray(g,b);if(i>-1){if((parseInt(h)*(Math.pow(1024,i)))<(parseInt(d)*(Math.pow(1024,e)))){return true}}}}else{alert("Incorect max file size definition!! ("+b.join(',')+")")}return false}function formatBytes(a,b){var c=['Bytes','KB','MB','GB','TB'];if(a===0)return'0 Byte';var i=parseInt(Math.floor(Math.log(a)/Math.log(1024)));return Math.round(a/Math.pow(1024,i),2)+c[i]}String.prototype.trunc=String.prototype.trunc||function(n){return this.length>n?this.substr(0,n-1)+'&hellip;':this};return k}})(jQuery);