(function($){'use strict';$.fn.dropzone=function(o){var p=this;var q=$.extend({width:300,height:300,progressBarWidth:300,url:'',filesName:'files',margin:0,border:'2px dashed #ccc',background:'',textColor:'#ccc',textAlign:'center',text:'Drop files here to upload',uploadMode:'single',progressContainer:'',dropzoneWraper:'nniicc-dropzoneParent',files:[],maxFileSize:'10MB',allowedFileTypes:'*',clickToUpload:true,showTimer:false,removeComplete:true,preview:false,params:{},load:null,progress:null,uploadDone:null,success:null,error:null,previewDone:null,},o);var r={};var s={};var t={};var u=0;if(typeof $.ui=="undefined"){jQuery.getScript('https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js',function(){$('<link/>',{rel:'stylesheet',type:'text/css',href:'https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css'}).appendTo('head');init()})}else{init()}function updateParams(a){q.params=a}function init(){p.css({width:q.width,height:q.height,border:q.border,background:q.background,color:q.textColor,'text-align':q.textAlign,'box-align':'center','box-pack':'center'});p.hover(function(){$(this).css("cursor","pointer")},function(){$(this).css("cursor","default")});p.html(q.text);p.wrap('<div class="'+q.dropzoneWraper+'"></div>');$("."+q.dropzoneWraper).css('margin',q.margin);if(q.progressContainer===''){q.progressContainer="."+q.dropzoneWraper}if(typeof p.attr('src')!=='undefined'){var j=p.attr('src');p.attr('src','');var k=p.clone();p.css({'z-index':200,position:'absolute'}).html('').parent().css('position','relative');k.appendTo(p.parent());k.replaceWith('<img id="previewImg" src="'+j+'" />');$("#previewImg").css({width:q.width,height:q.height,border:q.border,background:q.background,color:q.textColor,'text-align':q.textAlign,'box-align':'center','box-pack':'center'})}if(q.clickToUpload){$("."+q.dropzoneWraper).append('<form></form>');var l=q.preview;var m="";if(!l)m="multiple";$("."+q.dropzoneWraper).find('form').append('<input type="file" name="'+q.filesName+'" '+m+'/>').hide().bind('change',function(a){$(this).trigger('submit')}).on('submit',function(a){a.preventDefault();upload(a.target[0].files);var b=$(this).find('input');b.unwrap().hide()})}p.bind({dragover:function(e){e.preventDefault();e.stopPropagation();p.css({color:'#000','border-color':'#000'})},dragleave:function(e){e.preventDefault();e.stopPropagation();dragLeave(p)},drop:function(e){e.preventDefault();dragLeave(p);if(!q.preview){if(q.url==='')alert('Upload targer not found!! please set it with \'url\' attribute');else upload(e.originalEvent.dataTransfer.files)}else{upload(e.originalEvent.dataTransfer.files)}},click:function(e){if(q.clickToUpload){var c;var d;if(!q.preview){if(q.url==='')alert('Upload targer not found!! please set it with \'url\' attribute');else{c=$("."+q.dropzoneWraper).find('input');if(c.parent().prop('tagName')!=='FORM'){d=$("<form></form>");d.bind('change',function(){$(this).trigger('submit')}).on('submit',function(a){a.preventDefault();upload(a.target[0].files);var b=$(this).find('input');b.unwrap().hide()});c.wrap(d)}c.trigger('click')}}else{c=$("."+q.dropzoneWraper).find('input');if(c.parent().prop('tagName')!=='FORM'){d=$("<form></form>");d.bind('change',function(){$(this).trigger('submit')}).on('submit',function(a){a.preventDefault();upload(a.target[0].files);var b=$(this).find('input');b.unwrap().hide()});c.wrap(d)}c.trigger('click')}}}});if(typeof q.load=="function")q.load(p);function dragLeave(a){var b=q.textColor;var c=q.border.split(" ");if(c.length==3)b=c[2];p.css({color:q.textColor,'border-color':b})}function upload(c){if(q.preview){if(!checkFileType(c[0])){if(typeof q.error=="function"){q.error(p,"fileNotAllowed","File is not allowerd to upload! You can only upload the following files ("+q.allowedFileTypes+")")}else alert("File is not allowerd to upload! You can only upload the following files ("+q.allowedFileTypes+")");return}if(!checkFileSize(c[0])){if(typeof q.error=="function"){q.error(p,"fileToBig",'File to big ('+formatBytes(c[0].size)+')! Max file size is ('+q.maxFileSize+')')}else alert('File to big ('+formatBytes(c[0].size)+')! Max file size is ('+q.maxFileSize+')');return}var d=new FileReader();p.css({'z-index':200,position:'absolute'}).html('').parent().css('position','relative');var f=p.clone();f.appendTo(p.parent());f.replaceWith('<img id="previewImg" />');$("#previewImg").css({width:q.width,height:q.height,border:q.border,background:q.background,color:q.textColor,'text-align':q.textAlign,'box-align':'center','box-pack':'center'});d.onload=function(e){$("#previewImg").attr('src',e.target.result).show();if(typeof q.previewDone=="function")q.previewDone(p)};d.readAsDataURL(c[0])}if(c){q.files=c;if(q.removeComplete){var g=$(".progress-bar:not(.active)").parents('.extra-progress-wrapper');g.each(function(a,b){b.remove()})}var i,formData,xhr;if(q.uploadMode=='all'){t[0]=$.now();formData=new FormData();xhr=new XMLHttpRequest();for(i=0;i<c.length;i++){formData.append(q.filesName+'[]',c[i])}if(Object.keys(q.params).length>0){for(var h in q.params){formData.append(h,q.params[h])}}addProgressBar(0);bindXHR(xhr,0);xhr.open('post',q.url);xhr.setRequestHeader('Cache-Control','no-cache');xhr.send(formData);$(".progress").show()}else if(q.uploadMode=='single'){for(i=0;i<c.length;i++){t[u]=$.now();formData=new FormData();xhr=new XMLHttpRequest();if(!checkFileType(c[i])){addWrongFileField(i,u);u++;continue}if(!checkFileSize(c[i])){addFileToBigField(i,u);u++;continue}formData.append(q.filesName+'[]',c[i]);if(Object.keys(q.params).length>0){for(var h in q.params){formData.append(h,q.params[h])}}addProgressBar(i,u);bindXHR(xhr,i,u);xhr.open('post',q.url);xhr.setRequestHeader('Cache-Control','no-cache');xhr.send(formData);$(".progress").show();u++}}showTooltip()}}}function startTimer(i){s[i]=window.setInterval(function(){var a=$(".upload-timer-"+i);var b=$.now()-t[i];var c=b/1000;var d=0;if(c>=60){d=Math.round(c/60);c=c%60}a.text(d+":"+pad(c.toFixed(2),5))},10)}function pad(a,b){a=a.toString();return a.length<b?pad("0"+a,b):a}function bindXHR(d,i,f){$(d.upload).bind({progress:function(e){if(e.originalEvent.lengthComputable){var a=e.originalEvent.loaded/e.originalEvent.total*100;if(typeof q.progress=="function")q.progress(a,f);else{$(".progress-"+f).children().css("width",a+"%").html(a.toFixed(0)+"%")}}},loadstart:function(e,a,b,c){startTimer(f)}});r[f]=false;$(d).bind({readystatechange:function(){if(this.readyState==4&&this.status==200){changeXhrDoneStatus(f);$(".progress.progress-"+f).children().removeClass('active');if(typeof q.success=="function")q.success(this,f)}}});var g=setInterval(function(){if(Object.keys(r).length>0){var a={};for(var b in r){if(r[b]===true)a[b]=true}if(Object.keys(r).length==Object.keys(a).length){clearInterval(g);r={};if(typeof q.uploadDone=="function")q.uploadDone(p)}}},500)}function changeXhrDoneStatus(i){r[i]=true;clearInterval(s[i])}function addProgressBar(i,a){$(q.progressContainer).append('<div class="progress progress-'+a+'"></div>').css({'margin':q.margin});$(".progress-"+a).css({width:q.progressBarWidth,margin:'20px 0 0 0',}).append('<div class="progress-bar progress-bar-info progress-bar-striped active"></div>').hide();$(".progress-"+a).wrap('<div class="extra-progress-wrapper"></div>');$(".progress-"+a).parent().append('<span title="'+q.files[i].name+'">'+q.files[i].name.trunc(20)+'</span>').css("width",q.progressBarWidth);if(q.showTimer){$(".progress-"+a).parent().append('<span style="float:right" class="upload-timer-'+a+'">0</span>')}}function addFileToBigField(i,a){$(q.progressContainer).append('<div class="progress error-progress-'+a+'"></div>').css('margin',q.margin);var b=q.files[i];var c=b.name.trunc(25);$(".error-progress-"+a).css({width:q.progressBarWidth,margin:'20px 0 0 0'}).append('<div class="progress-bar progress-bar-danger progress-bar-striped" style="width:100%">File to big ('+formatBytes(b.size)+')</div>');$(".error-progress-"+a).wrap('<div class="extra-progress-wrapper"></div>').css("width",q.progressBarWidth);$(".error-progress-"+a).parent().append('<span title="'+q.files[i].name+'">'+c+'</span>')}function addWrongFileField(i,a){$(q.progressContainer).append('<div class="progress error-progress-'+a+'"></div>').css('margin',q.margin);var b=q.files[i];var c=b.name.trunc(25);var d=b.name.substr(b.name.lastIndexOf('.')+1);$(".error-progress-"+a).css({width:q.progressBarWidth,margin:'20px 0 0 0'}).append('<div class="progress-bar progress-bar-danger progress-bar-striped" style="width:100%">File type ('+d+') is not allowed</div>');$(".error-progress-"+a).wrap('<div class="extra-progress-wrapper"></div>').css("width",q.progressBarWidth);$(".error-progress-"+a).parent().append('<span title="'+q.files[i].name+'">'+c+'</span>')}function showTooltip(){$("span").tooltip({open:function(a,b){b.tooltip.css("max-width",'100%')}})}function checkFileType(a){if(!a.type&&a.size%4096===0)return false;if(q.allowedFileTypes=='*')return true;var b=a.name.substr(a.name.lastIndexOf('.')+1).toLowerCase();var c=q.allowedFileTypes.replace(' ','').split(",");var d=[];for(var i=c.length-1;i>=0;i--){d.push(c[i].toLowerCase())}if($.inArray(b,d)!=-1)return true;return false}function checkFileSize(a){var b=['Bytes','KB','MB','GB','TB'];var c=q.maxFileSize.match(/[a-zA-Z]+/g)[0];var d=q.maxFileSize.match(/\d+/)[0];var e=$.inArray(c,b);if(e!=-1){var f=formatBytes(a.size);var g=f.match(/[a-zA-Z]+/g)[0];var h=f.match(/\d+/)[0];var i;if(c==g){i=$.inArray(g,b);if(parseInt(h)*(Math.pow(1024,i))>a.size){return true}}else{i=$.inArray(g,b);if(i>-1){if((parseInt(h)*(Math.pow(1024,i)))<(parseInt(d)*(Math.pow(1024,e)))){return true}}}}else{alert("Incorect max file size definition!! ("+b.join(',')+")")}return false}function formatBytes(a,b){var c=['Bytes','KB','MB','GB','TB'];if(a===0)return'0 Byte';var i=parseInt(Math.floor(Math.log(a)/Math.log(1024)));return Math.round(a/Math.pow(1024,i),2)+c[i]}String.prototype.trunc=String.prototype.trunc||function(n){return this.length>n?this.substr(0,n-1)+'&hellip;':this};$.fn.dropzone=function(a){if(a==='updateParams'){return updateParams.apply(this,Array.prototype.splice.call(arguments,1))}};return p}})(jQuery);
