(function($){'use strict';$.fn.dropzone=function(k){var l=this;var m=$.extend({width:300,height:300,progressBarWidth:300,url:'',filesName:'files',margin:0,border:'2px dashed #ccc',background:'',textColor:'#ccc',textAlign:'center',text:'Drop files here to upload',uploadMode:'single',progressContainer:'',dropzoneWraper:'nniicc-dropzoneParent',files:[],maxFileSize:'10MB',allowedFileTypes:'*',clickToUpload:true,showTimer:true,removeComplete:true,preview:false,load:null,progress:null,uploadDone:null,error:null,previewDone:null,},k);var o={};var p={};var q={};var r=0;if(typeof $.ui=="undefined"){jQuery.getScript('https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js',function(){$('<link/>',{rel:'stylesheet',type:'text/css',href:'https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css'}).appendTo('head');init()})}else{init()}function init(){l.css({width:m.width,height:m.height,border:m.border,background:m.background,color:m.textColor,'text-align':m.textAlign,'box-align':'center','box-pack':'center'});l.hover(function(){$(this).css("cursor","pointer")},function(){$(this).css("cursor","default")});l.html(m.text);l.wrap('<div class="'+m.dropzoneWraper+'"></div>');$("."+m.dropzoneWraper).css('margin',m.margin);if(m.progressContainer===''){m.progressContainer="."+m.dropzoneWraper}if(l.attr('src')!==''){var h=l.attr('src');l.attr('src','');var j=l.clone();l.css({'z-index':200,position:'absolute'}).html('').parent().css('position','relative');j.appendTo(l.parent());j.replaceWith('<img id="previewImg" src="'+h+'" />');$("#previewImg").css({width:m.width,height:m.height,border:m.border,background:m.background,color:m.textColor,'text-align':m.textAlign,'box-align':'center','box-pack':'center'})}if(m.clickToUpload){$("."+m.dropzoneWraper).append('<form></form>');$("."+m.dropzoneWraper).find('form').append('<input type="file" name="'+m.filesName+'"/>').hide().bind('change',function(a){$(this).trigger('submit')}).on('submit',function(a){a.preventDefault();upload(a.target[0].files);var b=$(this).find('input');b.unwrap().hide()})}l.bind({dragover:function(e){e.preventDefault();e.stopPropagation();l.css({color:'#000','border-color':'#000'})},dragleave:function(e){e.preventDefault();e.stopPropagation();dragLeave(l)},drop:function(e){e.preventDefault();dragLeave(l);if(!m.preview){if(m.url==='')alert('Upload targer not found!! please set it with \'url\' attribute');else upload(e.originalEvent.dataTransfer.files)}else{upload(e.originalEvent.dataTransfer.files)}},click:function(e){if(m.clickToUpload){var c;var d;if(!m.preview){if(m.url==='')alert('Upload targer not found!! please set it with \'url\' attribute');else{c=$("."+m.dropzoneWraper).find('input');if(c.parent().prop('tagName')!=='FORM'){d=$("<form></form>");d.bind('change',function(){$(this).trigger('submit')}).on('submit',function(a){a.preventDefault();upload(a.target[0].files);var b=$(this).find('input');b.unwrap().hide()});c.wrap(d)}c.trigger('click')}}else{c=$("."+m.dropzoneWraper).find('input');if(c.parent().prop('tagName')!=='FORM'){d=$("<form></form>");d.bind('change',function(){$(this).trigger('submit')}).on('submit',function(a){a.preventDefault();upload(a.target[0].files);var b=$(this).find('input');b.unwrap().hide()});c.wrap(d)}c.trigger('click')}}}});if(typeof m.load=="function")m.load(l);function dragLeave(a){var b=m.textColor;var c=m.border.split(" ");if(c.length==3)b=c[2];l.css({color:m.textColor,'border-color':b})}function upload(c){if(m.preview){if(!checkFileType(c[0])){if(typeof m.error=="function"){m.error(l,"fileNotAllowed","File is not allowerd to upload! You can only upload the following files ("+m.allowedFileTypes+")")}else alert("File is not allowerd to upload! You can only upload the following files ("+m.allowedFileTypes+")");return}if(!checkFileSize(c[0])){if(typeof m.error=="function"){m.error(l,"fileToBig",'File to big ('+formatBytes(c[0].size)+')! Max file size is ('+m.maxFileSize+')')}else alert('File to big ('+formatBytes(c[0].size)+')! Max file size is ('+m.maxFileSize+')');return}var d=new FileReader();l.css({'z-index':200,position:'absolute'}).html('').parent().css('position','relative');var f=l.clone();f.appendTo(l.parent());f.replaceWith('<img id="previewImg" />');$("#previewImg").css({width:m.width,height:m.height,border:m.border,background:m.background,color:m.textColor,'text-align':m.textAlign,'box-align':'center','box-pack':'center'});d.onload=function(e){$("#previewImg").attr('src',e.target.result).show();if(typeof m.previewDone=="function")m.previewDone(l)};d.readAsDataURL(c[0])}else{if(c){m.files=c;if(m.removeComplete){var g=$(".progress-bar:not(.active)").parents('.extra-progress-wrapper');g.each(function(a,b){b.remove()})}var i,formData,xhr;if(m.uploadMode=='all'){q[0]=$.now();formData=new FormData();xhr=new XMLHttpRequest();for(i=0;i<c.length;i++){formData.append(m.filesName+'[]',c[i])}addProgressBar(0);bindXHR(xhr,0);xhr.open('post',m.url);xhr.setRequestHeader('Cache-Control','no-cache');xhr.send(formData);$(".progress").show()}else if(m.uploadMode=='single'){for(i=0;i<c.length;i++){q[r]=$.now();formData=new FormData();xhr=new XMLHttpRequest();if(!checkFileType(c[i])){addWrongFileField(i,r);r++;continue}if(!checkFileSize(c[i])){addFileToBigField(i,r);r++;continue}formData.append(m.filesName+'[]',c[i]);addProgressBar(i,r);bindXHR(xhr,i,r);xhr.open('post',m.url);xhr.setRequestHeader('Cache-Control','no-cache');xhr.send(formData);$(".progress").show();r++}}}showTooltip()}}}function startTimer(i){p[i]=window.setInterval(function(){var a=$(".upload-timer-"+i);var b=$.now()-q[i];var c=b/1000;var d=0;if(c>=60){d=Math.round(c/60);c=c%60}a.text(d+":"+pad(c.toFixed(2),5))},10)}function pad(a,b){a=a.toString();return a.length<b?pad("0"+a,b):a}function bindXHR(d,i,f){$(d.upload).bind({progress:function(e){if(e.originalEvent.lengthComputable){var a=e.originalEvent.loaded/e.originalEvent.total*100;if(typeof m.progress=="function")m.progress(a,f);else{$(".progress-"+f).children().css("width",a+"%").html(a.toFixed(0)+"%")}}},loadstart:function(e,a,b,c){startTimer(f)}});o[f]=false;$(d).bind({readystatechange:function(){if(this.readyState==4&&this.status==200){changeXhrDoneStatus(f);$(".progress.progress-"+f).children().removeClass('active')}}});var g=setInterval(function(){if(Object.keys(o).length>0){var a={};for(var b in o){if(o[b]===true)a[b]=true}if(Object.keys(o).length==Object.keys(a).length){clearInterval(g);o={};if(typeof m.uploadDone=="function")m.uploadDone(l)}}},500)}function changeXhrDoneStatus(i){o[i]=true;clearInterval(p[i])}function addProgressBar(i,a){$(m.progressContainer).append('<div class="progress progress-'+a+'"></div>').css({'margin':m.margin});$(".progress-"+a).css({width:m.progressBarWidth,margin:'20px 0 0 0',}).append('<div class="progress-bar progress-bar-info progress-bar-striped active"></div>').hide();$(".progress-"+a).wrap('<div class="extra-progress-wrapper"></div>');$(".progress-"+a).parent().append('<span title="'+m.files[i].name+'">'+m.files[i].name.trunc(20)+'</span>').css("width",m.progressBarWidth);if(m.showTimer){$(".progress-"+a).parent().append('<span style="float:right" class="upload-timer-'+a+'">0</span>')}}function addFileToBigField(i,a){$(m.progressContainer).append('<div class="progress error-progress-'+a+'"></div>').css('margin',m.margin);var b=m.files[i];var c=b.name.trunc(25);$(".error-progress-"+a).css({width:m.progressBarWidth,margin:'20px 0 0 0'}).append('<div class="progress-bar progress-bar-danger progress-bar-striped" style="width:100%">File to big ('+formatBytes(b.size)+')</div>');$(".error-progress-"+a).wrap('<div class="extra-progress-wrapper"></div>').css("width",m.progressBarWidth);$(".error-progress-"+a).parent().append('<span title="'+m.files[i].name+'">'+c+'</span>')}function addWrongFileField(i,a){$(m.progressContainer).append('<div class="progress error-progress-'+a+'"></div>').css('margin',m.margin);var b=m.files[i];var c=b.name.trunc(25);var d=b.name.substr(b.name.lastIndexOf('.')+1);$(".error-progress-"+a).css({width:m.progressBarWidth,margin:'20px 0 0 0'}).append('<div class="progress-bar progress-bar-danger progress-bar-striped" style="width:100%">File type ('+d+') is not allowed</div>');$(".error-progress-"+a).wrap('<div class="extra-progress-wrapper"></div>').css("width",m.progressBarWidth);$(".error-progress-"+a).parent().append('<span title="'+m.files[i].name+'">'+c+'</span>')}function showTooltip(){$("span").tooltip({open:function(a,b){b.tooltip.css("max-width",'100%')}})}function checkFileType(a){if(!a.type&&a.size%4096===0)return false;if(m.allowedFileTypes=='*')return true;var b=a.name.substr(a.name.lastIndexOf('.')+1).toLowerCase();var c=m.allowedFileTypes.replace(' ','').split(",");var d=[];for(var i=c.length-1;i>=0;i--){d.push(c[i].toLowerCase())}if($.inArray(b,d)!=-1)return true;return false}function checkFileSize(a){var b=['Bytes','KB','MB','GB','TB'];var c=m.maxFileSize.match(/[a-zA-Z]+/g)[0];var d=m.maxFileSize.match(/\d+/)[0];var e=$.inArray(c,b);if(e!=-1){var f=formatBytes(a.size);var g=f.match(/[a-zA-Z]+/g)[0];var h=f.match(/\d+/)[0];var i;if(c==g){i=$.inArray(g,b);if(parseInt(h)*(Math.pow(1024,i))>a.size){return true}}else{i=$.inArray(g,b);if(i>-1){if((parseInt(h)*(Math.pow(1024,i)))<(parseInt(d)*(Math.pow(1024,e)))){return true}}}}else{alert("Incorect max file size definition!! ("+b.join(',')+")")}return false}function formatBytes(a,b){var c=['Bytes','KB','MB','GB','TB'];if(a===0)return'0 Byte';var i=parseInt(Math.floor(Math.log(a)/Math.log(1024)));return Math.round(a/Math.pow(1024,i),2)+c[i]}String.prototype.trunc=String.prototype.trunc||function(n){return this.length>n?this.substr(0,n-1)+'&hellip;':this};return l}})(jQuery);
