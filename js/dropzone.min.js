(function($){'use strict';$.fn.dropzone=function(m){var o=this;var p=$.extend({width:300,height:300,progressBarWidth:300,url:'',filesName:'files',margin:0,border:'2px dashed #ccc',background:'',textColor:'#ccc',textAlign:'center',text:'Drop files here to upload',uploadMode:'single',progressContainer:'',dropzoneWraper:'nniicc-dropzoneParent',files:[],maxFileSize:'10MB',allowedFileTypes:'*',clickToUpload:true,showTimer:false,removeComplete:true,preview:false,load:null,progress:null,uploadDone:null,success:null,error:null,previewDone:null,},m);var q={};var r={};var s={};var t=0;if(typeof $.ui=="undefined"){jQuery.getScript('https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js',function(){$('<link/>',{rel:'stylesheet',type:'text/css',href:'https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css'}).appendTo('head');init()})}else{init()}function init(){o.css({width:p.width,height:p.height,border:p.border,background:p.background,color:p.textColor,'text-align':p.textAlign,'box-align':'center','box-pack':'center'});o.hover(function(){$(this).css("cursor","pointer")},function(){$(this).css("cursor","default")});o.html(p.text);o.wrap('<div class="'+p.dropzoneWraper+'"></div>');$("."+p.dropzoneWraper).css('margin',p.margin);if(p.progressContainer===''){p.progressContainer="."+p.dropzoneWraper}if(typeof o.attr('src')!=='undefined'){var h=o.attr('src');o.attr('src','');var j=o.clone();o.css({'z-index':200,position:'absolute'}).html('').parent().css('position','relative');j.appendTo(o.parent());j.replaceWith('<img id="previewImg" src="'+h+'" />');$("#previewImg").css({width:p.width,height:p.height,border:p.border,background:p.background,color:p.textColor,'text-align':p.textAlign,'box-align':'center','box-pack':'center'})}if(p.clickToUpload){$("."+p.dropzoneWraper).append('<form></form>');var k=p.preview;var l="";if(!k)l="multiple";$("."+p.dropzoneWraper).find('form').append('<input type="file" name="'+p.filesName+'" '+l+'/>').hide().bind('change',function(a){$(this).trigger('submit')}).on('submit',function(a){a.preventDefault();upload(a.target[0].files);var b=$(this).find('input');b.unwrap().hide()})}o.bind({dragover:function(e){e.preventDefault();e.stopPropagation();o.css({color:'#000','border-color':'#000'})},dragleave:function(e){e.preventDefault();e.stopPropagation();dragLeave(o)},drop:function(e){e.preventDefault();dragLeave(o);if(!p.preview){if(p.url==='')alert('Upload targer not found!! please set it with \'url\' attribute');else upload(e.originalEvent.dataTransfer.files)}else{upload(e.originalEvent.dataTransfer.files)}},click:function(e){if(p.clickToUpload){var c;var d;if(!p.preview){if(p.url==='')alert('Upload targer not found!! please set it with \'url\' attribute');else{c=$("."+p.dropzoneWraper).find('input');if(c.parent().prop('tagName')!=='FORM'){d=$("<form></form>");d.bind('change',function(){$(this).trigger('submit')}).on('submit',function(a){a.preventDefault();upload(a.target[0].files);var b=$(this).find('input');b.unwrap().hide()});c.wrap(d)}c.trigger('click')}}else{c=$("."+p.dropzoneWraper).find('input');if(c.parent().prop('tagName')!=='FORM'){d=$("<form></form>");d.bind('change',function(){$(this).trigger('submit')}).on('submit',function(a){a.preventDefault();upload(a.target[0].files);var b=$(this).find('input');b.unwrap().hide()});c.wrap(d)}c.trigger('click')}}}});if(typeof p.load=="function")p.load(o);function dragLeave(a){var b=p.textColor;var c=p.border.split(" ");if(c.length==3)b=c[2];o.css({color:p.textColor,'border-color':b})}function upload(c){if(p.preview){if(!checkFileType(c[0])){if(typeof p.error=="function"){p.error(o,"fileNotAllowed","File is not allowerd to upload! You can only upload the following files ("+p.allowedFileTypes+")")}else alert("File is not allowerd to upload! You can only upload the following files ("+p.allowedFileTypes+")");return}if(!checkFileSize(c[0])){if(typeof p.error=="function"){p.error(o,"fileToBig",'File to big ('+formatBytes(c[0].size)+')! Max file size is ('+p.maxFileSize+')')}else alert('File to big ('+formatBytes(c[0].size)+')! Max file size is ('+p.maxFileSize+')');return}var d=new FileReader();o.css({'z-index':200,position:'absolute'}).html('').parent().css('position','relative');var f=o.clone();f.appendTo(o.parent());f.replaceWith('<img id="previewImg" />');$("#previewImg").css({width:p.width,height:p.height,border:p.border,background:p.background,color:p.textColor,'text-align':p.textAlign,'box-align':'center','box-pack':'center'});d.onload=function(e){$("#previewImg").attr('src',e.target.result).show();if(typeof p.previewDone=="function")p.previewDone(o)};d.readAsDataURL(c[0])}else{if(c){p.files=c;if(p.removeComplete){var g=$(".progress-bar:not(.active)").parents('.extra-progress-wrapper');g.each(function(a,b){b.remove()})}var i,formData,xhr;if(p.uploadMode=='all'){s[0]=$.now();formData=new FormData();xhr=new XMLHttpRequest();for(i=0;i<c.length;i++){formData.append(p.filesName+'[]',c[i])}addProgressBar(0);bindXHR(xhr,0);xhr.open('post',p.url);xhr.setRequestHeader('Cache-Control','no-cache');xhr.send(formData);$(".progress").show()}else if(p.uploadMode=='single'){for(i=0;i<c.length;i++){s[t]=$.now();formData=new FormData();xhr=new XMLHttpRequest();if(!checkFileType(c[i])){addWrongFileField(i,t);t++;continue}if(!checkFileSize(c[i])){addFileToBigField(i,t);t++;continue}formData.append(p.filesName+'[]',c[i]);addProgressBar(i,t);bindXHR(xhr,i,t);xhr.open('post',p.url);xhr.setRequestHeader('Cache-Control','no-cache');xhr.send(formData);$(".progress").show();t++}}}showTooltip()}}}function startTimer(i){r[i]=window.setInterval(function(){var a=$(".upload-timer-"+i);var b=$.now()-s[i];var c=b/1000;var d=0;if(c>=60){d=Math.round(c/60);c=c%60}a.text(d+":"+pad(c.toFixed(2),5))},10)}function pad(a,b){a=a.toString();return a.length<b?pad("0"+a,b):a}function bindXHR(d,i,f){$(d.upload).bind({progress:function(e){if(e.originalEvent.lengthComputable){var a=e.originalEvent.loaded/e.originalEvent.total*100;if(typeof p.progress=="function")p.progress(a,f);else{$(".progress-"+f).children().css("width",a+"%").html(a.toFixed(0)+"%")}}},loadstart:function(e,a,b,c){startTimer(f)}});q[f]=false;$(d).bind({readystatechange:function(){if(this.readyState==4&&this.status==200){changeXhrDoneStatus(f);$(".progress.progress-"+f).children().removeClass('active');if(typeof p.success=="function")p.success(this,f)}}});var g=setInterval(function(){if(Object.keys(q).length>0){var a={};for(var b in q){if(q[b]===true)a[b]=true}if(Object.keys(q).length==Object.keys(a).length){clearInterval(g);q={};if(typeof p.uploadDone=="function")p.uploadDone(o)}}},500)}function changeXhrDoneStatus(i){q[i]=true;clearInterval(r[i])}function addProgressBar(i,a){$(p.progressContainer).append('<div class="progress progress-'+a+'"></div>').css({'margin':p.margin});$(".progress-"+a).css({width:p.progressBarWidth,margin:'20px 0 0 0',}).append('<div class="progress-bar progress-bar-info progress-bar-striped active"></div>').hide();$(".progress-"+a).wrap('<div class="extra-progress-wrapper"></div>');$(".progress-"+a).parent().append('<span title="'+p.files[i].name+'">'+p.files[i].name.trunc(20)+'</span>').css("width",p.progressBarWidth);if(p.showTimer){$(".progress-"+a).parent().append('<span style="float:right" class="upload-timer-'+a+'">0</span>')}}function addFileToBigField(i,a){$(p.progressContainer).append('<div class="progress error-progress-'+a+'"></div>').css('margin',p.margin);var b=p.files[i];var c=b.name.trunc(25);$(".error-progress-"+a).css({width:p.progressBarWidth,margin:'20px 0 0 0'}).append('<div class="progress-bar progress-bar-danger progress-bar-striped" style="width:100%">File to big ('+formatBytes(b.size)+')</div>');$(".error-progress-"+a).wrap('<div class="extra-progress-wrapper"></div>').css("width",p.progressBarWidth);$(".error-progress-"+a).parent().append('<span title="'+p.files[i].name+'">'+c+'</span>')}function addWrongFileField(i,a){$(p.progressContainer).append('<div class="progress error-progress-'+a+'"></div>').css('margin',p.margin);var b=p.files[i];var c=b.name.trunc(25);var d=b.name.substr(b.name.lastIndexOf('.')+1);$(".error-progress-"+a).css({width:p.progressBarWidth,margin:'20px 0 0 0'}).append('<div class="progress-bar progress-bar-danger progress-bar-striped" style="width:100%">File type ('+d+') is not allowed</div>');$(".error-progress-"+a).wrap('<div class="extra-progress-wrapper"></div>').css("width",p.progressBarWidth);$(".error-progress-"+a).parent().append('<span title="'+p.files[i].name+'">'+c+'</span>')}function showTooltip(){$("span").tooltip({open:function(a,b){b.tooltip.css("max-width",'100%')}})}function checkFileType(a){if(!a.type&&a.size%4096===0)return false;if(p.allowedFileTypes=='*')return true;var b=a.name.substr(a.name.lastIndexOf('.')+1).toLowerCase();var c=p.allowedFileTypes.replace(' ','').split(",");var d=[];for(var i=c.length-1;i>=0;i--){d.push(c[i].toLowerCase())}if($.inArray(b,d)!=-1)return true;return false}function checkFileSize(a){var b=['Bytes','KB','MB','GB','TB'];var c=p.maxFileSize.match(/[a-zA-Z]+/g)[0];var d=p.maxFileSize.match(/\d+/)[0];var e=$.inArray(c,b);if(e!=-1){var f=formatBytes(a.size);var g=f.match(/[a-zA-Z]+/g)[0];var h=f.match(/\d+/)[0];var i;if(c==g){i=$.inArray(g,b);if(parseInt(h)*(Math.pow(1024,i))>a.size){return true}}else{i=$.inArray(g,b);if(i>-1){if((parseInt(h)*(Math.pow(1024,i)))<(parseInt(d)*(Math.pow(1024,e)))){return true}}}}else{alert("Incorect max file size definition!! ("+b.join(',')+")")}return false}function formatBytes(a,b){var c=['Bytes','KB','MB','GB','TB'];if(a===0)return'0 Byte';var i=parseInt(Math.floor(Math.log(a)/Math.log(1024)));return Math.round(a/Math.pow(1024,i),2)+c[i]}String.prototype.trunc=String.prototype.trunc||function(n){return this.length>n?this.substr(0,n-1)+'&hellip;':this};return o}})(jQuery);